-- === 1) Último registro de DISPUTE por pz_ins_key ===
WITH dispute_latest AS (
  SELECT
    d.pz_ins_key,
    d.cov_inskey,
    d.case_id,
    d.case_type,
    d.case_sta,
    d.case_mode,
    d.cm15,
    d.cstone_last_updatetm,
    ROW_NUMBER() OVER (
      PARTITION BY d.pz_ins_key
      ORDER BY d.cstone_last_updatetm DESC
    ) AS rn
  FROM `axp-lumi.dw.gdm_dispute` d
),
-- === 2) Último ResolveCase por case_id desde EVENT ===
event_latest AS (
  SELECT
    e.case_id,
    DATE(e.event_ts_gmt) AS latest_rslv_ts
  FROM `axp-lumi.dw.gdm_event` e
  WHERE e.event_type = 'Task'
    AND e.event_id   = 'ResolveCase'
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY e.case_id
    ORDER BY e.event_ts_gmt DESC
  ) = 1
),
-- === 3) Último mkt_cd por pz_ins_key desde CLAIM (para cm_mkt) ===
mkt_latest AS (
  SELECT
    c.pz_ins_key,
    c.mkt_cd,
    ROW_NUMBER() OVER (
      PARTITION BY c.pz_ins_key
      ORDER BY c.cstone_last_updatetm DESC
    ) AS rn
  FROM `axp-lumi.dw.gdm_claim` c
),
-- === 4) Último ajuste por case_id (usando substring del pz_ins_key) ===
adj_latest AS (
  SELECT
    SUBSTRING(pz_ins_key, 25, 11) AS case_id_sub,
    adj_type AS adj_type1,
    adj_ts_gmt
  FROM `axp-lumi.dw.gdm_adjustment`
  WHERE adj_or_liab_shft = 'Adjustment'
  QUALIFY ROW_NUMBER() OVER (
    PARTITION BY SUBSTRING(pz_ins_key, 25, 11)
    ORDER BY adj_ts_gmt DESC
  ) = 1
)

-- === 5) SELECT final con joins y filtros ===
SELECT
  a.case_id,                              -- 1) case_id (dispute)
  ev.latest_rslv_ts AS latest_rslv_dt,    -- 2) último resolve date (event)
  a.cm15,                                 -- 3) cm15 (dispute)

  -- 5 campos pedidos:
  adj.adj_type1,
  c.latest_rslv_note,
  d.slct_ltr_id,
  d.ltr_ds,
  d.creat_ts_gmt

FROM dispute_latest a
LEFT JOIN event_latest ev
  ON ev.case_id = a.case_id
LEFT JOIN adj_latest adj
  ON adj.case_id_sub = a.case_id
LEFT JOIN `axp-lumi.dw.gsn_clic_case_detail` c
  ON a.case_id = c.cust_lst_nm              -- tal como indicaste
LEFT JOIN `axp-lumi.dw.gdm_letter_req` d
  ON a.case_id = SUBSTRING(d.pz_ins_key, 25, 11)
LEFT JOIN mkt_latest mk
  ON a.cov_inskey = mk.pz_ins_key AND mk.rn = 1
WHERE
  a.rn = 1
  AND a.case_type = 'Dispute'
  AND a.case_sta  = 'Resolved-Completed'
  AND a.case_mode IN ('E2E','SPLIT','ISSUER')
  AND ev.latest_rslv_ts BETWEEN '2025-08-25' AND '2025-09-10'
  AND mk.mkt_cd = '005'                    -- cm_mkt = 005 según último mkt_cd
;
